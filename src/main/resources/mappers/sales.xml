<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="sales">

    <select id="idxLatestProduct" resultType="com.cafe24.nonchrono.dto.SalesDTO">
        select ss_num, gm_code, sl_id, ss_name, ss_price, ss_speriod, ss_eperiod, ss_stock, ss_img, ss_status, ss_description, dv_num
        from tb_sales
        where ss_status = 'S1'
        order by ss_speriod desc
    </select>

    <select id="idxTopProduct" resultType="com.cafe24.nonchrono.dto.SalesDTO">
        select sa.ss_num, ss_name, ss_price, ss_img
        from tb_sales sa
                 join tb_detail dt
                      on sa.ss_num = dt.ss_num
        group by dt.ss_num
        order by count(*) desc
    </select>

    <select id="idxReviewProduct" resultType="com.cafe24.nonchrono.dto.SalesDTO">
        select sa.ss_num, ss_name, ss_price, ss_img
        from tb_sales sa
                 join tb_review rv
                      on sa.ss_num = rv.ss_num
        group by sa.ss_num
        order by count(*) desc
    </select>

    <select id="idxFeaturedProduct" resultType="com.cafe24.nonchrono.dto.SalesDTO">
        select ss_num, ss_name, ss_price, ss_img
        from tb_sales
        order by ss_eperiod
    </select>

    <select id="idxRankingSales" resultType="com.cafe24.nonchrono.dto.GameDTO">
        select ga.gm_name
        from tb_detail dt
                 join tb_sales sa
                      on dt.ss_num = sa.ss_num
                 join tb_game ga
                      on sa.gm_code = ga.gm_code
        group by ga.gm_code
        order by count(*) desc
    </select>

    <!-- 목록 출력-->
    <select id="list" resultType="com.cafe24.nonchrono.dto.SalesDTO">
        select ss_num, gm_code, sl_id, ss_name, ss_price, ss_speriod, ss_eperiod, ss_stock, ss_img, ss_status, ss_description, dv_num
        FROM tb_sales
        ORDER BY ss_num DESC
    </select>

    <!-- 상품 글 등록하기 -->
    <insert id="insert" parameterType="com.cafe24.nonchrono.dto.SalesDTO">
        INSERT INTO tb_sales (gm_code, sl_id, ss_price, ss_speriod, ss_eperiod, ss_stock, ss_img, ss_status,
                              ss_description, dv_num, ss_name)
        VALUES (#{gm_code}, 'codingking', #{ss_price}, now(), #{ss_eperiod}, #{ss_stock}, #{ss_img}, #{ss_status},
                #{ss_description}, '1', #{ss_name})
    </insert>

    <select id="list2" resultType="com.cafe24.nonchrono.dto.SalesDTO">
        select ss_num, ss_name, ss_price, ss_status, ss_speriod
        from tb_sales
        where sl_id = 'codingking'
        ORDER BY ss_num DESC
    </select>

    <select id="totalRowCount" resultType="int">
        select count(*)
        from tb_sales
        where sl_id = #{sl_id}
        group by sl_id
    </select>

    <select id="list3" parameterType="com.cafe24.nonchrono.dto.PagingDTO" resultType="com.cafe24.nonchrono.dto.SalesDTO">
    <![CDATA[
        select *
        from(
                select *,  @rno := @rno +1 as r
                from(
                    select ss_img, ss_price, ss_name
                    from tb_sales
                    where sl_id = #{sl_id}
                    ) AA,
                    (select @rno :=0) BB
            )CC
        where r>= #{startRow} and r <= #{endRow}
        ]]>
    </select>
    
    <select id="searchAll" parameterType="String" resultType="com.cafe24.nonchrono.dto.SalesDTO">
        select ss_num, gm_code, sl_id, ss_name, ss_price, ss_speriod, ss_eperiod, ss_stock, ss_img, ss_status, ss_description, dv_num
        from tb_sales
        where ss_name like #{ss_name}
    </select>

    <select id="searchCategory" parameterType="com.cafe24.nonchrono.dto.SalesDTO" resultType="com.cafe24.nonchrono.dto.SalesDTO">
        select ss_num, gm_code, sl_id, ss_name, ss_price, ss_speriod, ss_eperiod, ss_stock, ss_img, ss_status, ss_description, dv_num
        from tb_sales
        where gm_code = #{gm_code} and ss_name like #{ss_name}
    </select>
    <!-- 상품 번호와 맞는 상세정보 가져오기 -->
    <select id="detail" parameterType="int" resultType="com.cafe24.nonchrono.dto.SalesDTO">
        select  ss_num, gm_code, sl_id, ss_name, ss_price, ss_speriod, ss_eperiod, ss_stock, ss_img, ss_status, ss_description, dv_num
        from tb_sales
        where ss_num = #{ss_num}
    </select>

    <!-- 상품 품목(게임)의 상세 정보 가져오기 -->
    <select id="gameDetail" parameterType="int" resultType="com.cafe24.nonchrono.dto.GameDTO">
        SELECT gm.gm_code,  gm.gm_name, gm.gm_price, gm.gm_level, gm.gm_category, gm.gm_img
        FROM tb_sales as rb join tb_game as gm
                                 on rb.gm_code = gm.gm_code
        WHERE ss_num = #{ss_num}
    </select>

    <select id="reviewCount" resultType="int">
        select ifnull(count(*),0)
        from(
                select count(*)
                from tb_review
                where ss_num = #{ss_num}
                group by ss_num
            ) aa
    </select>

    <select id="reviewDetail" parameterType="int" resultType="com.cafe24.nonchrono.dto.ReviewDTO">
        SELECT rv_num, mem_id, rv_content, rv_star, rv_filename, ss_num
        from tb_review
        WHERE ss_num = #{ss_num}
    </select>
</mapper>
